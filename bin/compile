#!/usr/bin/ruby

require 'optparse'
require_relative '../lib/cidr'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: compile -r [ROUTE_FILE] -n [NOROUTE_FILE]"

  opts.on("-r", "--route /path/to/file", "Routes that should be included") do |v|
    options[:route_file] = v
  end

  opts.on("-n", "--noroute /path/to/file", "Routes that must be excluded") do |v|
    options[:noroute_file] = v
  end
end.parse!

routes = File.open(options[:route_file], 'r').each_line.map { |prefix| CIDR.new(prefix.chomp) }
noroutes = File.open(options[:noroute_file], 'r').each_line.map { |prefix| CIDR.new(prefix.chomp) }

noroutes.each do |subnet|
  routes = routes.map do |network|
    network.exclude subnet
  end.flatten
end

routes.flatten.each { |p| puts p }
